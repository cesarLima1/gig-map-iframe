<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Girls in Gear - Where are we located?</title>

    <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

    <!-- Papa Parse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #f8e1ff 0%, #e1f5fe 50%, #f0e6ff 100%);
        height: 100vh;
        overflow: hidden;
        box-sizing: border-box;
      }

      /* TOP HEADER SECTION */
      .header {
        background: rgb(251, 242, 252);
        padding: 20px;
        text-align: center;
        border-bottom: 1px solid rgba(0, 188, 212, 0.1);
      }

      .header-title {
        color: #00bcd4;
        font-size: 48px;
        font-weight: 800;
        margin-bottom: 25px;
        letter-spacing: -1px;
      }

      .header-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        max-width: 600px;
        margin: 0 auto;
      }

      .select-location {
        background: #00bcd4;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 2px 12px rgba(0, 188, 212, 0.3);
        transition: all 0.2s ease;
        position: relative;
      }

      .select-location:hover {
        background: #0097a7;
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 188, 212, 0.4);
      }

      .select-location:after {
        content: '‚ñº';
        margin-left: 8px;
        font-size: 10px;
      }

      .separator {
        color: rgba(0, 188, 212, 0.3);
        font-size: 24px;
        font-weight: 300;
        line-height: 1;
      }

      .search-container {
        position: relative;
        flex: 1;
        max-width: 280px;
      }

      .search-input {
        width: 100%;
        padding: 12px 15px 12px 45px;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 14px;
        background: white;
        transition: all 0.2s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: #00bcd4;
        box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.1);
      }

      .search-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        font-size: 16px;
      }

      .reset-button {
        background: #e0f7fa;
        color: #00838f;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .reset-button:hover {
        background: #b2ebf2;
        transform: translateY(-2px);
      }

      /* MAIN CONTENT AREA */
      .main-container {
        display: flex;
        height: calc(100vh - 150px);
        background: linear-gradient(135deg, #f8e1ff 0%, #e1f5fe 50%, #f0e6ff 100%);
        border-right: 10vw solid rgb(251, 242, 252);
        border-bottom: 10vw solid rgb(251, 242, 252);
        border-left: 10vw solid rgb(251, 242, 252);
        border-radius: 20px;
        box-sizing: border-box;
      }

      /* LEFT SIDEBAR - LOCATIONS LIST */
      .locations-sidebar {
        width: 380px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 20px;
        overflow: hidden; /* Remove scrollbar from sidebar */
        display: flex;
        flex-direction: column;
      }

      .chapter-info {
        background: rgba(224, 247, 250, 0.9);
        backdrop-filter: blur(5px);
        padding: 16px 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        border-left: 4px solid #00bcd4;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 12px rgba(0, 188, 212, 0.1);
        flex-shrink: 0; /* Prevent shrinking */
      }

      .chapter-info-text h3 {
        color: #00838f;
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 4px;
      }

      .chapter-info-text p {
        color: #555;
        font-size: 13px;
        font-weight: 500;
      }

      .share-icon {
        color: #00bcd4;
        font-size: 20px;
        cursor: pointer;
      }

      .locations-list {
        flex: 1; /* Take remaining space */
        overflow-y: auto; /* Only this element scrolls */
        padding-right: 8px;
      }

      .location-item {
        display: flex;
        align-items: flex-start;
        padding: 16px 12px;
        border-bottom: none;
        cursor: pointer;
        transition: all 0.2s ease;
        border-radius: 12px;
        margin-bottom: 8px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(5px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 188, 212, 0.1);
      }

      .location-item:hover {
        background: rgba(248, 253, 255, 0.95);
        transform: translateX(4px);
        box-shadow: 0 4px 16px rgba(0, 188, 212, 0.15);
        border-color: rgba(0, 188, 212, 0.2);
      }

      .location-icon {
        width: 36px;
        height: 36px;
        background: #00bcd4;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 14px;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(0, 188, 212, 0.2);
      }

      .location-icon::after {
        content: 'üö≤';
        font-size: 16px;
      }

      .location-details {
        flex: 1;
        min-width: 0;
      }

      .location-name {
        color: #00bcd4;
        font-size: 15px;
        font-weight: 700;
        margin-bottom: 6px;
        line-height: 1.3;
        word-wrap: break-word;
      }

      .location-address {
        color: #666;
        font-size: 13px;
        margin-bottom: 4px;
        font-weight: 500;
      }

      .location-contact {
        color: #666;
        font-size: 12px;
        display: flex;
        align-items: center;
        margin-bottom: 4px;
        font-weight: 500;
      }

      .location-contact::before {
        content: 'üìû';
        margin-right: 6px;
        font-size: 11px;
      }

      .location-website {
        color: #00bcd4;
        font-size: 12px;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.2s ease;
        display: flex;
        align-items: center;
      }

      .location-website:hover {
        color: #0097a7;
      }

      .location-website::before {
        content: 'üåê';
        margin-right: 6px;
        font-size: 11px;
      }

      .expand-arrow {
        color: #ccc;
        font-size: 18px;
        margin-left: 10px;
        flex-shrink: 0;
      }

      /* RIGHT SIDE - MAP */
      .map-container {
        flex: 1;
        position: relative;
        overflow: hidden;
      }

      #map {
        width: 100%;
        height: 100%;
        border: none;
      }

      /* MAP POPUP STYLING */
      .mapboxgl-popup-content {
        background: white;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        border: 2px solid #00bcd4;
        padding: 20px;
        min-width: 280px;
      }

      .popup-title {
        color: #00bcd4;
        font-weight: 700;
        font-size: 16px;
        margin-bottom: 10px;
      }

      .popup-address {
        color: #666;
        font-size: 14px;
        margin-bottom: 6px;
        font-weight: 500;
      }

      .popup-contact {
        color: #666;
        font-size: 13px;
        margin-bottom: 12px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .view-directions {
        background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 14px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0, 188, 212, 0.3);
      }

      .view-directions:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 188, 212, 0.4);
      }

      /* Scrollbar styling - ONLY for locations-list */
      .locations-list::-webkit-scrollbar {
        width: 6px;
      }

      .locations-list::-webkit-scrollbar-track {
        background: rgba(0, 188, 212, 0.05);
        border-radius: 3px;
      }

      .locations-list::-webkit-scrollbar-thumb {
        background: #00bcd4;
        border-radius: 3px;
      }

      .locations-list::-webkit-scrollbar-thumb:hover {
        background: #0097a7;
      }

      /* Remove mapbox attribution and controls */
      .mapboxgl-ctrl-bottom-left,
      .mapboxgl-ctrl-bottom-right {
        display: none !important;
      }

      .mapboxgl-ctrl-top-right .mapboxgl-ctrl-group:not(:first-child) {
        display: none !important;
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .header-title {
          font-size: 32px;
        }

        .header-controls {
          flex-direction: column;
          gap: 10px;
        }

        .search-container {
          max-width: 100%;
          width: 100%;
        }

        .main-container {
          flex-direction: column;
        }

        .locations-sidebar {
          width: 100%;
          height: 200px;
          border-right: none;
          border-bottom: 1px solid rgba(0, 188, 212, 0.1);
        }

        .locations-list {
          max-height: 120px;
        }
      }
    </style>
  </head>
  <body>
    <!-- TOP HEADER SECTION -->
    <div class="header">
      <h1 class="header-title">Where are we located?</h1>
      <div class="header-controls">
        <button class="select-location">Select Location</button>
        <div class="separator">|</div>
        <div class="search-container">
          <div class="search-icon">üîç</div>
          <input type="text" class="search-input" placeholder="Vienna, VA 22181" value="Vienna, VA 22181" />
        </div>
        <div class="separator">|</div>
        <button class="reset-button">Reset Map</button>
      </div>
    </div>

    <!-- MAIN CONTENT AREA -->
    <div class="main-container">
      <!-- LEFT SIDEBAR - LOCATIONS LIST -->
      <div class="locations-sidebar">
        <div class="chapter-info">
          <div class="chapter-info-text">
            <h3>48 Local Chapters Found</h3>
            <p>Girls in your area need your support!</p>
          </div>
        </div>

        <div class="locations-list">
          <div class="location-item">
            <div class="location-icon"></div>
            <div class="location-details">
              <div class="location-name">Girls on the Run Alaska</div>
              <div class="location-address">Anchorage, Matanuska-Susitna</div>
              <div class="location-contact">(907) 306-0789</div>
              <a href="#" class="location-website">www.gotrsouthcentalak.org</a>
            </div>
            <div class="expand-arrow">‚Ä∫</div>
          </div>

          <div class="location-item">
            <div class="location-icon"></div>
            <div class="location-details">
              <div class="location-name">Girls on the Run Southcentral Ala...</div>
              <div class="location-address">Anchorage, Matanuska-Susitna</div>
              <div class="location-contact">(907) 306-0789</div>
              <a href="#" class="location-website">www.gotrsouthcentalak.org</a>
            </div>
            <div class="expand-arrow">‚Ä∫</div>
          </div>

          <div class="location-item">
            <div class="location-icon"></div>
            <div class="location-details">
              <div class="location-name">Girls on the Run Southcentral Ala...</div>
              <div class="location-address">Anchorage, Matanuska-Susitna</div>
              <div class="location-contact">(907) 306-0789</div>
              <a href="#" class="location-website">www.gotrsouthcentalak.org</a>
            </div>
            <div class="expand-arrow">‚Ä∫</div>
          </div>

          <div class="location-item">
            <div class="location-icon"></div>
            <div class="location-details">
              <div class="location-name">Girls on the Run Southcentral Ala...</div>
              <div class="location-address">Anchorage, Matanuska-Susitna</div>
              <div class="location-contact">(907) 306-0789</div>
              <a href="#" class="location-website">www.gotrsouthcentalak.org</a>
            </div>
            <div class="expand-arrow">‚Ä∫</div>
          </div>

          <div class="location-item">
            <div class="location-icon"></div>
            <div class="location-details">
              <div class="location-name">Girls on the Run Southcentral Ala...</div>
              <div class="location-address">Anchorage, Matanuska-Susitna</div>
              <div class="location-contact">(907) 306-0789</div>
              <a href="#" class="location-website">www.gotrsouthcentalak.org</a>
            </div>
            <div class="expand-arrow">‚Ä∫</div>
          </div>

          <div class="location-item">
            <div class="location-icon"></div>
            <div class="location-details">
              <div class="location-name">Girls on the Run Test Location 1</div>
              <div class="location-address">Test City, Test State</div>
              <div class="location-contact">(555) 123-4567</div>
              <a href="#" class="location-website">www.example.org</a>
            </div>
            <div class="expand-arrow">‚Ä∫</div>
          </div>

          <div class="location-item">
            <div class="location-icon"></div>
            <div class="location-details">
              <div class="location-name">Girls on the Run Test Location 2</div>
              <div class="location-address">Another City, Another State</div>
              <div class="location-contact">(555) 987-6543</div>
              <a href="#" class="location-website">www.example2.org</a>
            </div>
            <div class="expand-arrow">‚Ä∫</div>
          </div>
        </div>
      </div>

      <!-- RIGHT SIDE - MAP -->
      <div class="map-container">
        <div id="map"></div>
      </div>
    </div>

    <script>
      // ===== GLOBAL CONFIGURATION =====
      mapboxgl.accessToken =
        'pk.eyJ1IjoiZ2lybHNpbmdlYXIiLCJhIjoiY2xwcmF1ajNlMDdiOTJpb2xpcjI5dXF3YiJ9.gAAFitjNaaaHyWJ86qdG9A';

      // Global variable to store processed data
      let globalGigData = [];
      let isLoadingData = false;

      // Google Sheet URL converted to CSV
      // To get the CSV URL from your Google Sheet:
      // 1. Go to your Google Sheet
      // 2. File > Share > Publish to web
      // 3. Select "Comma-separated values (.csv)"
      // 4. Copy the generated URL
      
      // Original URL (with CORS blocked)
      const ORIGINAL_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1ygPq1Cfz0zW1pPCvdFB_R4yTh_XmKman7Pv__eVJePM/export?format=csv&gid=719830008';
      
      // URL with CORS proxy (solution to CORS error)
      const GOOGLE_SHEET_CSV_URL = `https://api.allorigins.win/get?url=${encodeURIComponent(ORIGINAL_SHEET_URL)}`;
      
      // Alternative CORS proxy URLs (in case the first one fails)
      const CORS_PROXIES = [
        `https://api.allorigins.win/get?url=${encodeURIComponent(ORIGINAL_SHEET_URL)}`,
        `https://corsproxy.io/?${encodeURIComponent(ORIGINAL_SHEET_URL)}`,
        `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(ORIGINAL_SHEET_URL)}`
      ];

      // ===== SAMPLE DATA FOR TESTING =====
      const sampleGigData = [
        {
          id: 1,
          programType: 'Pedal Power',
          address: 'Bernardsville Municipal Pool 141 Seney Drive',
          address2: '',
          city: 'Bernardsville',
          state: 'NJ',
          zip: '07924',
          ageRange: '5-7',
          meetingDay: 'Sunday',
          meetingTime: '9:00-10:30am',
          region: 'Raritan New Jersey',
          registrationStatus: 'Register Now',
          acceptingVolunteers: 'Coach',
          coordinates: null // Will be filled with geocoding
        },
        {
          id: 2,
          programType: 'Pedal Power',
          address: 'Bernardsville Municipal Pool 141 Seney Drive',
          address2: '',
          city: 'Bernardsville',
          state: 'NJ',
          zip: '07924',
          ageRange: '8-10',
          meetingDay: 'Sunday',
          meetingTime: '9:00-10:30am',
          region: 'Raritan New Jersey',
          registrationStatus: 'Register Now',
          acceptingVolunteers: 'Coach',
          coordinates: null
        },
        {
          id: 3,
          programType: 'Camp GiG',
          address: 'Blue Ridge Cyclery at Libbie Mill 5001 Libbie Mill E Blvd',
          address2: '',
          city: 'Richmond',
          state: 'VA',
          zip: '23230',
          ageRange: '11+',
          meetingDay: '6/9/2025-6/13/2025',
          meetingTime: '9-1pm',
          region: 'Greater Richmond',
          registrationStatus: 'Register Now',
          acceptingVolunteers: 'Coach',
          coordinates: null
        },
        {
          id: 4,
          programType: 'Camp GiG',
          address: 'Blue Ridge Cyclery at Libbie Mill 5001 Libbie Mill E Blvd',
          address2: '',
          city: 'Richmond',
          state: 'VA',
          zip: '23230',
          ageRange: '11+',
          meetingDay: '6/16/2025-6/20/2025',
          meetingTime: '9-1pm',
          region: 'Greater Richmond',
          registrationStatus: 'Register Now',
          acceptingVolunteers: 'Coach',
          coordinates: null
        }
      ];

      // ===== FUNCTION TO FETCH AND PROCESS GOOGLE SHEET DATA =====
      async function fetchGoogleSheetData() {
        try {
          isLoadingData = true;
          console.log('üì• Fetching data from Google Sheet...');
          
          // Show loading indicator
          updateLoadingState(true);

          let csvText = null;
          let lastError = null;

          // Try with different CORS proxies
          for (let i = 0; i < CORS_PROXIES.length; i++) {
            try {
              console.log(`üîÑ Trying proxy ${i + 1}/${CORS_PROXIES.length}...`);
              
              const response = await fetch(CORS_PROXIES[i]);
              
              if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status}`);
              }

              const data = await response.json();
              
              // Handle different proxy response formats
              if (data.contents) {
                // allorigins.win format
                csvText = data.contents;
                
                // Check if it's a Data URL (data:text/csv;base64,...)
                if (csvText.startsWith('data:')) {
                  console.log('üîÑ Detected Data URL, extracting base64...');
                  const base64Index = csvText.indexOf('base64,');
                  if (base64Index !== -1) {
                    const base64Content = csvText.substring(base64Index + 7); // 7 = "base64,".length
                    try {
                      csvText = atob(base64Content);
                      console.log('‚úÖ Data URL decoded successfully');
                    } catch (e) {
                      console.error('‚ùå Error decoding Data URL base64:', e);
                      throw new Error('Error decoding Data URL');
                    }
                  } else {
                    throw new Error('Data URL without base64 not supported');
                  }
                }
                // Check if it comes in pure base64 (without Data URL)
                else if (data.status && data.status.content_type && 
                    data.status.content_type.includes('text') === false) {
                  console.log('üîÑ Decoding base64 content...');
                  try {
                    csvText = atob(data.contents);
                  } catch (e) {
                    console.warn('‚ö†Ô∏è Error decoding base64, trying as plain text');
                  }
                }
                // Check if it looks like pure base64 (contains typical base64 characters)
                else if (csvText && !csvText.includes(',') && /^[A-Za-z0-9+/=]+$/.test(csvText.replace(/\s/g, ''))) {
                  console.log('üîÑ Detected pure base64 content, decoding...');
                  try {
                    csvText = atob(csvText);
                  } catch (e) {
                    console.warn('‚ö†Ô∏è Error decoding detected base64');
                  }
                }
                
              } else if (typeof data === 'string') {
                // Direct response - check if it's Data URL too
                csvText = data;
                if (csvText.startsWith('data:')) {
                  console.log('üîÑ Detected Data URL in direct response...');
                  const base64Index = csvText.indexOf('base64,');
                  if (base64Index !== -1) {
                    const base64Content = csvText.substring(base64Index + 7);
                    try {
                      csvText = atob(base64Content);
                    } catch (e) {
                      console.error('‚ùå Error decoding direct Data URL:', e);
                    }
                  }
                }
              } else if (data.data) {
                // Another possible format
                csvText = data.data;
              } else {
                throw new Error('Unrecognized response format');
              }
              
              // If we get here, we succeeded
              console.log('‚úÖ Data obtained successfully with proxy', i + 1);
              console.log('üìã Content type received:', typeof csvText);
              console.log('üìÑ First 200 characters:', csvText ? csvText.substring(0, 200) : 'null');
              console.log('üìä Content length:', csvText ? csvText.length : 0);

              break;
              
            } catch (error) {
              console.warn(`‚ö†Ô∏è Error with proxy ${i + 1}:`, error.message);
              lastError = error;
              
              // If it's not the last proxy, continue
              if (i < CORS_PROXIES.length - 1) {
                console.log('üîÑ Trying next proxy...');
                continue;
              }
            }
          }

          // If we couldn't get data with any proxy
          if (!csvText) {
            throw new Error(`Could not get data with any proxy. Last error: ${lastError?.message}`);
          }
          
          return new Promise((resolve, reject) => {
            Papa.parse(csvText, {
              header: true,
              skipEmptyLines: true,
              transformHeader: function(header) {
                // Clean and normalize column names
                return header.trim()
                  .replace(/\s+/g, '')
                  .replace(/([A-Z])/g, (match, letter, index) => {
                    return index > 0 ? letter.toLowerCase() : letter.toLowerCase();
                  });
              },
              complete: function(results) {
                if (results.errors.length > 0) {
                  console.error('‚ùå CSV parsing errors:', results.errors);
                  reject(new Error('Error parsing CSV data'));
                  return;
                }
                console.log(results.data);
                console.log('‚úÖ Data parsed successfully:', results.data.length, 'rows');
                resolve(results.data);
              },
              error: function(error) {
                console.error('‚ùå Papa Parse error:', error);
                reject(error);
              }
            });
          });

        } catch (error) {
          console.error('‚ùå Error fetching Google Sheet data:', error);
          throw error;
        } finally {
          isLoadingData = false;
          updateLoadingState(false);
        }
      }

      // ===== FUNCTION TO PROCESS AND NORMALIZE DATA =====
      function processSheetData(rawData) {
        console.log('üîÑ Processing data...');
        
        return rawData.map((row, index) => {
          // Map columns according to your structure
          const processedRow = {
            id: index + 1,
            programType: row.programtype || row['Program Type'] || '',
            address: row.address || row['Address'] || '',
            address2: row.address2 || row['Address 2'] || '',
            city: row.city || row['City'] || '',
            state: row.state || row['State'] || '',
            zip: row.zip || row['Zip'] || '',
            ageRange: row.agerange || row['Age Range'] || '',
            meetingDay: row.meetingday || row['Meeting Day'] || '',
            meetingTime: row.meetingtime || row['Meeting Time'] || '',
            region: row.region || row['Region'] || '',
            registrationStatus: row.registrationstatus || row['Registration Status'] || '',
            acceptingVolunteers: row.acceptingvolunteers || row['Accepting Volunteers'] || '',
            coordinates: null // Will be filled with geocoding
          };
          
          return processedRow;
        }).filter(row => row.address && row.city && row.state); // Filter rows with essential data
      }

      // ===== FUNCTION TO GEOCODE ADDRESSES =====
      async function geocodeAddress(address, city, state, zip) {
        try {
          // Build complete address
          const fullAddress = `${address}${address ? ', ' : ''}${city}, ${state} ${zip}`.trim();
          
          // Mapbox Geocoding API URL
          const geocodingUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(fullAddress)}.json?access_token=${mapboxgl.accessToken}&country=US&limit=1`;
          
          const response = await fetch(geocodingUrl);
          
          if (!response.ok) {
            throw new Error(`Geocoding error: ${response.status}`);
          }
          
          const data = await response.json();
          
          if (data.features && data.features.length > 0) {
            const coordinates = data.features[0].center; // [lng, lat]
            console.log(`‚úÖ Geocoded: ${fullAddress} -> [${coordinates[0]}, ${coordinates[1]}]`);
            return coordinates;
          } else {
            console.warn(`‚ö†Ô∏è No coordinates found for: ${fullAddress}`);
            return null;
          }
          
        } catch (error) {
          console.error(`‚ùå Error geocoding ${address}:`, error);
          return null;
        }
      }

      // ===== FUNCTION TO GEOCODE ALL DATA =====
      async function geocodeAllData(data) {
        console.log('üó∫Ô∏è Starting geocoding of', data.length, 'locations...');
        
        const geocodedData = [];
        
        for (let i = 0; i < data.length; i++) {
          const item = data[i];
          
          // Add small delay to avoid rate limits
          if (i > 0) {
            await new Promise(resolve => setTimeout(resolve, 100));
          }
          
          const coordinates = await geocodeAddress(
            item.address,
            item.city,
            item.state,
            item.zip
          );
          
          geocodedData.push({
            ...item,
            coordinates: coordinates
          });
          
          // Update progress
          const progress = Math.round(((i + 1) / data.length) * 100);
          console.log(`üìç Geocoding progress: ${progress}% (${i + 1}/${data.length})`);
        }
        
        console.log('‚úÖ Geocoding completed');
        return geocodedData;
      }

      // ===== MAIN FUNCTION TO LOAD AND PROCESS DATA =====
      async function loadGigData(useSheetData = true) {
        try {
          let rawData;
          
          if (useSheetData) {
            // Try to load data from Google Sheet
            try {
              rawData = await fetchGoogleSheetData();
            } catch (error) {
              console.warn('‚ö†Ô∏è Error loading Google Sheet, using sample data:', error);
              rawData = sampleGigData;
              useSheetData = false;
            }
          } else {
            rawData = sampleGigData;
          }
          
          // Process data
          const processedData = useSheetData ? processSheetData(rawData) : rawData;
          
          // Geocode addresses
          const geocodedData = await geocodeAllData(processedData);
          
          // Store in global variable
          globalGigData = geocodedData;
          
          console.log('üéâ Data loaded successfully:', globalGigData.length, 'programs');
          
          // Update UI
          updateLocationsList(globalGigData);
          updateMapMarkers(globalGigData);
          
          return globalGigData;
          
        } catch (error) {
          console.error('‚ùå Error loading data:', error);
          
          // Fallback to sample data
          if (useSheetData) {
            console.log('üîÑ Trying with sample data...');
            return await loadGigData(false);
          }
          
          throw error;
        }
      }

      // ===== FUNCTION TO UPDATE LOADING STATE =====
      function updateLoadingState(isLoading) {
        const chapterInfo = document.querySelector('.chapter-info-text h3');
        const chapterSubtext = document.querySelector('.chapter-info-text p');
        
        if (isLoading) {
          chapterInfo.textContent = 'Loading data...';
          chapterSubtext.textContent = 'Getting programs from Google Sheets';
        }
      }

      // ===== FUNCTION TO UPDATE LOCATIONS LIST =====
      function updateLocationsList(data) {
        const locationsList = document.querySelector('.locations-list');
        const chapterInfo = document.querySelector('.chapter-info-text h3');
        const chapterSubtext = document.querySelector('.chapter-info-text p');
        
        // Update counter
        chapterInfo.textContent = `${data.length} Programs Found`;
        chapterSubtext.textContent = 'Girls in Gear programs near you!';
        
        // Clear existing list
        locationsList.innerHTML = '';
        
        // Add new elements
        data.forEach((program) => {
          const locationItem = document.createElement('div');
          locationItem.className = 'location-item';
          locationItem.innerHTML = `
            <div class="location-icon"></div>
            <div class="location-details">
              <div class="location-name">${program.programType} - ${program.ageRange}</div>
              <div class="location-address">${program.address}, ${program.city}, ${program.state} ${program.zip}</div>
              <div class="location-contact">${program.meetingDay} | ${program.meetingTime}</div>
              <div class="location-website" style="color: #00bcd4; font-weight: 600;">
                ${program.region} | ${program.registrationStatus}
              </div>
            </div>
            <div class="expand-arrow">‚Ä∫</div>
          `;
          
          // Add click event
          locationItem.addEventListener('click', function() {
            if (program.coordinates) {
              map.flyTo({
                center: program.coordinates,
                zoom: 12,
                duration: 1000
              });
            }
          });
          
          locationsList.appendChild(locationItem);
        });
      }

      // ===== FUNCTION TO UPDATE MAP MARKERS =====
      function updateMapMarkers(data) {
        // Filter data with valid coordinates
        const validData = data.filter(program => program.coordinates);
        
        console.log(`üìç Adding ${validData.length} markers to map`);
        
        validData.forEach((program) => {
          // Create popup
          const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(`
            <div class="popup-title">${program.programType}</div>
            <div class="popup-address">${program.address}<br>${program.city}, ${program.state} ${program.zip}</div>
            <div class="popup-contact">üìÖ ${program.meetingDay}</div>
            <div class="popup-contact">‚è∞ ${program.meetingTime}</div>
            <div class="popup-contact">üë• Ages: ${program.ageRange}</div>
            <div class="popup-contact">üìç ${program.region}</div>
            <button class="view-directions" onclick="openDirections('${program.address}, ${program.city}, ${program.state} ${program.zip}')">
              View Directions
            </button>
          `);

          // Create marker
          const marker = new mapboxgl.Marker({
            color: '#00BCD4'
          })
            .setLngLat(program.coordinates)
            .setPopup(popup)
            .addTo(map);
        });
      }

      // ===== FUNCTION TO OPEN DIRECTIONS =====
      function openDirections(address) {
        const encodedAddress = encodeURIComponent(address);
        window.open(`https://www.google.com/maps/search/?api=1&query=${encodedAddress}`, '_blank');
      }

      // ===== SEARCH FUNCTION =====
      function searchPrograms(query) {
        if (!query.trim()) {
          updateLocationsList(globalGigData);
          return;
        }
        
        const filtered = globalGigData.filter(program => {
          const searchText = `${program.programType} ${program.address} ${program.city} ${program.state} ${program.region} ${program.ageRange}`.toLowerCase();
          return searchText.includes(query.toLowerCase());
        });
        
        updateLocationsList(filtered);
        console.log(`üîç Search "${query}": ${filtered.length} results`);
      }

      // ===== MAP INITIALIZATION =====
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/girlsingear/cmbica3mo006k01s6a8in69g5',
        center: [-98.5795, 39.8283],
        zoom: 3.5,
        attributionControl: false
      });

      // ===== EVENTS AND INITIALIZATION =====
      map.on('load', async function () {
        console.log('üó∫Ô∏è Map loaded, starting data loading...');
        
        // Load data when map loads
        try {
          await loadGigData(true);
        } catch (error) {
          console.error('‚ùå Critical error loading data:', error);
          alert('Error loading data. Please contact administrator.');
        }
      });

      // Reset map functionality
      document.querySelector('.reset-button').addEventListener('click', function () {
        map.flyTo({
          center: [-98.5795, 39.8283],
          zoom: 3.5,
          duration: 1000
        });
        
        // Reset search
        document.querySelector('.search-input').value = '';
        updateLocationsList(globalGigData);
      });

      // Search functionality
      document.querySelector('.search-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          searchPrograms(this.value);
        }
      });

      // Search on input
      document.querySelector('.search-input').addEventListener('input', function (e) {
        searchPrograms(this.value);
      });

      // ===== DEVELOPMENT AND DEBUG FUNCTIONS =====
      
      // Function to manually reload data
      window.reloadData = async function() {
        console.log('üîÑ Manually reloading data...');
        await loadGigData(true);
      };
      
      // Function to use sample data
      window.useSampleData = async function() {
        console.log('üß™ Loading sample data...');
        await loadGigData(false);
      };
      
      // Function to export current data
      window.exportData = function() {
        console.log('üì§ Current data:', globalGigData);
        const dataStr = JSON.stringify(globalGigData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'gig-data.json';
        link.click();
      };

      // Function to test direct sheet access (for debug)
      window.testDirectAccess = async function() {
        console.log('üß™ Testing direct Google Sheet access...');
        try {
          const response = await fetch(ORIGINAL_SHEET_URL);
          console.log('‚úÖ Direct access works!', response.status);
          const text = await response.text();
          console.log('üìÑ Data:', text.substring(0, 200) + '...');
        } catch (error) {
          console.error('‚ùå Direct access error:', error);
        }
      };

      // Function to test proxies individually
      window.testProxies = async function() {
        console.log('üß™ Testing all CORS proxies...');
        
        for (let i = 0; i < CORS_PROXIES.length; i++) {
          try {
            console.log(`üîç Testing proxy ${i + 1}: ${CORS_PROXIES[i]}`);
            const response = await fetch(CORS_PROXIES[i]);
            const data = await response.json();
            console.log(`‚úÖ Proxy ${i + 1} works!`, data);
          } catch (error) {
            console.error(`‚ùå Proxy ${i + 1} failed:`, error);
          }
        }
      };

      // Function to get sheet info
      window.getSheetInfo = function() {
        console.log('üìã Google Sheet Information:');
        console.log('üîó Original URL:', ORIGINAL_SHEET_URL);
        console.log('üîó Proxy URL:', GOOGLE_SHEET_CSV_URL);
        console.log('üìä Data loaded:', globalGigData.length, 'programs');
        console.log('üó∫Ô∏è With coordinates:', globalGigData.filter(d => d.coordinates).length);
      };

      // Function to manually test decoding
      window.testBase64Decode = async function() {
        console.log('üß™ Testing manual decoding...');
        try {
          const response = await fetch(CORS_PROXIES[0]);
          const data = await response.json();
          
          console.log('üìã Complete proxy response:', data);
          
          if (data.contents) {
            console.log('üìÑ Original content (first 100 chars):', data.contents.substring(0, 100));
            
            let csvText = data.contents;
            
            // Check if it's Data URL
            if (csvText.startsWith('data:')) {
              console.log('üîç It\'s a Data URL!');
              const base64Index = csvText.indexOf('base64,');
              if (base64Index !== -1) {
                console.log('üîç Found base64 marker at position:', base64Index);
                const base64Content = csvText.substring(base64Index + 7);
                console.log('üìÑ Base64 content (first 100 chars):', base64Content.substring(0, 100));
                
                try {
                  const decoded = atob(base64Content);
                  console.log('‚úÖ Content decoded successfully!');
                  console.log('üìÑ Decoded CSV (first 500 chars):', decoded.substring(0, 500));
                  console.log('üìä Decoded length:', decoded.length);
                  
                  // Try parsing with Papa Parse
                  Papa.parse(decoded, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                      console.log('‚úÖ Papa Parse successful!');
                      console.log('üìä Number of rows:', results.data.length);
                      console.log('üìã Headers found:', results.meta.fields);
                      if (results.data.length > 0) {
                        console.log('üìÑ First row:', results.data[0]);
                        console.log('üìÑ Second row:', results.data[1]);
                      }
                    },
                    error: function(error) {
                      console.error('‚ùå Papa Parse error:', error);
                    }
                  });
                  
                } catch (e) {
                  console.error('‚ùå Error decoding base64 from Data URL:', e);
                }
              } else {
                console.warn('‚ö†Ô∏è Data URL without base64 marker');
              }
            } else {
              console.log('üîç Looks like pure base64?', /^[A-Za-z0-9+/=\s]+$/.test(csvText));
              
              try {
                const decoded = atob(csvText);
                console.log('‚úÖ Content decoded as pure base64 (first 500 chars):', decoded.substring(0, 500));
                console.log('üìä Decoded length:', decoded.length);
              } catch (e) {
                console.error('‚ùå Error decoding as pure base64:', e);
                console.log('üìÑ Trying as plain text...');
                console.log('üìÑ Plain text (first 500 chars):', csvText.substring(0, 500));
              }
            }
          }
          
        } catch (error) {
          console.error('‚ùå Test error:', error);
        }
      };
    </script>
  </body>
</html>
